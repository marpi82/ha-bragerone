name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secrets:
    name: secrets (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-review:
    name: dependency
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-ghsas: GHSA-cfh3-3jmp-rvhc

  quality:
    name: quality (lint + typecheck)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout py-bragerone
        uses: actions/checkout@v6
        with:
          repository: marpi82/py-bragerone
          ref: main
          path: py-bragerone

      - name: Link py-bragerone for uv editable source
        run: ln -sfn "$GITHUB_WORKSPACE/py-bragerone" "$GITHUB_WORKSPACE/../py-bragerone"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --locked --group dev --group test

      - name: Ruff (lint)
        run: uv run --group dev ruff check .

      - name: Ruff (format)
        run: uv run --group dev ruff format --check

      - name: mypy (typecheck)
        run: uv run --group dev mypy

  security:
    name: security (bandit + semgrep + pip-audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout py-bragerone
        uses: actions/checkout@v6
        with:
          repository: marpi82/py-bragerone
          ref: main
          path: py-bragerone

      - name: Link py-bragerone for uv editable source
        run: ln -sfn "$GITHUB_WORKSPACE/py-bragerone" "$GITHUB_WORKSPACE/../py-bragerone"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --locked --group dev --group test

      - name: Run Bandit
        run: uv run --group dev bandit -r custom_components -q -f json -o bandit-report.json
        continue-on-error: true

      - name: Run Semgrep
        run: uv run --group dev semgrep --config p/ci --error .

      - name: Run pip-audit
        run: |
          uv run --group dev pip-audit \
            --format=json \
            --output=pip-audit-results.json \
            --progress-spinner=off \
            --skip-editable
        continue-on-error: true

      - name: Upload security artifacts
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: security-results-${{ github.sha }}
          path: |
            bandit-report.json
            pip-audit-results.json
          retention-days: 30

  hassfest:
    name: hassfest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: home-assistant/actions/hassfest@master

  validate-ha:
    name: validate-ha
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate manifest.json
        run: |
          python -c "
          import json
          manifest = json.load(open('custom_components/habragerone/manifest.json'))
          required_keys = ['domain', 'name', 'version', 'documentation', 'issue_tracker', 'codeowners']
          missing = [key for key in required_keys if key not in manifest]
          if missing:
              raise ValueError(f'Missing required keys in manifest.json: {missing}')
          print('manifest.json is valid')
          "

      - name: Validate strings.json
        run: |
          python -c "
          import json
          json.load(open('custom_components/habragerone/strings.json'))
          print('strings.json is valid')
          "

  tests:
    name: tests (3.13)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout py-bragerone
        uses: actions/checkout@v6
        with:
          repository: marpi82/py-bragerone
          ref: main
          path: py-bragerone

      - name: Link py-bragerone for uv editable source
        run: ln -sfn "$GITHUB_WORKSPACE/py-bragerone" "$GITHUB_WORKSPACE/../py-bragerone"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --locked --group dev --group test

      - name: Run pytest
        run: uv run --group test pytest -q --maxfail=1 --disable-warnings --cov=custom_components.habragerone --cov-report=xml --cov-report=term-missing

      - name: Upload coverage reports to Codecov
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: ha-bragerone
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: build
    runs-on: ubuntu-latest
    needs: [secrets, dependency-review, quality, security, hassfest, validate-ha, tests]
    if: always() && needs.quality.result == 'success' && needs.hassfest.result == 'success' && needs.validate-ha.result == 'success' && needs.tests.result == 'success' && needs.secrets.result == 'success'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout py-bragerone
        uses: actions/checkout@v6
        with:
          repository: marpi82/py-bragerone
          ref: main
          path: py-bragerone

      - name: Link py-bragerone for uv editable source
        run: ln -sfn "$GITHUB_WORKSPACE/py-bragerone" "$GITHUB_WORKSPACE/../py-bragerone"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --locked --group dev

      - name: Build package
        run: uv run --group dev hatch build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v7
        with:
          name: dist-${{ github.sha }}
          path: dist/*
          retention-days: 7

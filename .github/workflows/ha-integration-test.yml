name: Home Assistant Integration Test

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    schedule:
        # Test against latest HA dev every night
        - cron: "0 2 * * *"

jobs:
    integration-test:
        name: HA Integration Test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                home-assistant-version:
                    - "2025.5.0"
                    - "latest"
                    - "dev" # Latest development version
        services:
            homeassistant:
                image: homeassistant/home-assistant:${{ matrix.home-assistant-version == 'dev' && 'dev' || (matrix.home-assistant-version == 'latest' && 'stable' || matrix.home-assistant-version) }}
                options: >-
                    --health-cmd="curl -f http://localhost:8123 || exit 1"
                    --health-interval=30s
                    --health-timeout=10s
                    --health-retries=5
                    --health-start-period=30s
                ports:
                    - 8123:8123
                volumes:
                    - /tmp/homeassistant:/config

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.13

            - name: Install dependencies
              run: uv sync --group dev --group test

            - name: Install Home Assistant ${{ matrix.home-assistant-version }}
              if: matrix.home-assistant-version != 'dev'
              run: |
                  if [[ "${{ matrix.home-assistant-version }}" == "latest" ]]; then
                    uv add homeassistant
                  else
                    uv add homeassistant==${{ matrix.home-assistant-version }}
                  fi

            - name: Install Home Assistant dev
              if: matrix.home-assistant-version == 'dev'
              run: uv add git+https://github.com/home-assistant/core.git

            - name: Setup Home Assistant config
              run: |
                  sudo mkdir -p /tmp/homeassistant/custom_components
                  sudo cp -r custom_components/habragerone /tmp/homeassistant/custom_components/
                  sudo tee /tmp/homeassistant/configuration.yaml > /dev/null <<EOF
                  default_config:

                  logger:
                    default: info
                    logs:
                      custom_components.habragerone: debug

                  # Test our integration
                  habragerone:
                    # Add minimal config here when implemented
                  EOF

            - name: Wait for Home Assistant to start
              run: |
                  echo "Waiting for Home Assistant to start..."
                  timeout 300 bash -c 'until curl -f http://localhost:8123; do sleep 5; done'

            - name: Test integration loading
              run: |
                  # Check if our integration is loaded
                  response=$(curl -s http://localhost:8123/api/ || echo "failed")
                  if [[ "$response" == "failed" ]]; then
                    echo "❌ Home Assistant API not accessible"
                    exit 1
                  fi
                  echo "✅ Home Assistant is running"

                  # Check logs for our integration
                  if docker logs homeassistant_homeassistant_1 2>&1 | grep -q "habragerone"; then
                    echo "✅ Integration habragerone found in logs"
                  else
                    echo "⚠️  Integration habragerone not found in logs (may be expected if not configured)"
                  fi

            - name: Run integration tests
              run: |
                  # Run tests that require Home Assistant to be running
                  uv run --group test pytest tests/ -k "integration" -v || echo "No integration tests found"

            - name: Check Home Assistant logs
              if: always()
              run: |
                  echo "=== Home Assistant Logs ==="
                  docker logs homeassistant_homeassistant_1 2>&1 | tail -50

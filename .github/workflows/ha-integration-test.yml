name: Home Assistant Integration Test

on:
    push:
    pull_request:
    schedule:
        # Test against latest HA dev every night
        - cron: "0 2 * * *"

permissions:
    contents: read

jobs:
    integration-test:
        name: HA Integration Test
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
            matrix:
                home-assistant-version:
                    - "2025.5.1"
                    - "latest"
                    - "dev" # Latest development version

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Checkout py-bragerone
              uses: actions/checkout@v6
              with:
                  repository: marpi82/py-bragerone
                  ref: main
                  path: py-bragerone

            - name: Link py-bragerone for uv editable source
              run: ln -sfn "$GITHUB_WORKSPACE/py-bragerone" "$GITHUB_WORKSPACE/../py-bragerone"

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.13

            - name: Install dependencies
              run: uv sync --group dev --group test

            - name: Resolve Home Assistant image tag
              id: ha-image
              run: |
                  version="${{ matrix.home-assistant-version }}"
                  if [[ "$version" == "dev" ]]; then
                    tag="dev"
                  elif [[ "$version" == "latest" ]]; then
                    tag="stable"
                  else
                    tag="$version"
                  fi
                  echo "tag=$tag" >> "$GITHUB_OUTPUT"

            - name: Setup Home Assistant config
              run: |
                  sudo mkdir -p /tmp/homeassistant/custom_components
                  sudo cp -r custom_components/habragerone /tmp/homeassistant/custom_components/
                  sudo tee /tmp/homeassistant/configuration.yaml > /dev/null <<EOF
                  default_config:

                  logger:
                    default: info
                    logs:
                      custom_components.habragerone: debug
                  EOF

            - name: Start Home Assistant container
              run: |
                  docker run -d \
                    --name ha-under-test \
                    --health-cmd="curl -f http://localhost:8123 || exit 1" \
                    --health-interval=30s \
                    --health-timeout=10s \
                    --health-retries=10 \
                    --health-start-period=60s \
                    -p 8123:8123 \
                    -v /tmp/homeassistant:/config \
                    homeassistant/home-assistant:${{ steps.ha-image.outputs.tag }}

            - name: Wait for Home Assistant to start
              run: |
                  echo "Waiting for Home Assistant to start..."
                  timeout 420 bash -c 'until curl -fsS http://localhost:8123/ > /dev/null; do sleep 5; done'

            - name: Test integration loading
              run: |
                  # Check if Home Assistant is reachable
                  if ! curl -fsS http://localhost:8123/ > /dev/null; then
                    echo "❌ Home Assistant API not accessible"
                    exit 1
                  fi
                  echo "✅ Home Assistant is running"

                  # Check logs for our integration
                  if docker logs ha-under-test 2>&1 | grep -q "habragerone"; then
                    echo "✅ Integration habragerone found in logs"
                  else
                    echo "⚠️  Integration habragerone not found in logs (may be expected if not configured)"
                  fi

            - name: Run integration tests
              run: |
                  # Run tests that require Home Assistant to be running
                  uv run --group test pytest tests/ -k "integration" -v || echo "No integration tests found"

            - name: Check Home Assistant logs
              if: always()
              run: |
                  echo "=== Home Assistant Logs ==="
                  docker logs ha-under-test 2>&1 | tail -50

            - name: Stop Home Assistant container
              if: always()
              run: |
                  docker rm -f ha-under-test >/dev/null 2>&1 || true
